<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Taskmate ‚Äî –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .hidden {
      display: none;
    }
    .error {
      color: red;
      margin: 10px 0;
    }
    .task-item {
      position: relative;
      padding-right: 60px;
      margin-bottom: 10px;
      border: 1px solid #dee2e6;
      padding: 10px;
      border-radius: 5px;
    }
    .task-item .delete-btn {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: red;
      cursor: pointer;
      border: none;
      background: none;
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      margin-top: 20px;
      background: #dee2e6;
    }
    .calendar-day {
      border: 1px solid #dee2e6;
      padding: 5px;
      min-height: 120px;
      background: #fff;
      position: relative;
    }
    .calendar-day:hover {
      background: #f8f9fa;
    }
    .calendar-day-header {
      font-weight: bold;
      text-align: center;
      padding: 5px;
      background: #e9ecef;
    }
    .calendar-task-count {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #007bff;
      color: white;
      padding: 2px 6px;
      border-radius: 50%;
      font-size: 12px;
      min-width: 16px;
      text-align: center;
    }
    .calendar-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .calendar-day span {
      display: block;
      font-size: 14px;
      margin-bottom: 5px;
    }
    .task-modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      width: 300px;
      max-height: 80vh;
      overflow-y: auto;
    }
    .task-modal.active {
      display: block;
      animation: modalFadeIn 0.3s ease forwards;
    }
    .task-modal:not(.active) {
      animation: modalFadeOut 0.3s ease forwards;
    }
    .task-modal-content {
      margin-bottom: 15px;
    }
    .task-modal-content h3 {
      margin: 0 0 10px;
      font-size: 16px;
    }
    .task-modal-content ul {
      list-style: none;
      padding: 0;
    }
    .task-modal-content .task-mini-block {
      border: 1px solid #dee2e6;
      border-radius: 5px;
      padding: 10px;
      margin-bottom: 10px;
      background: #f8f9fa;
    }
    .task-mini-block h4 {
      margin: 0 0 5px;
      font-size: 14px;
      font-weight: bold;
    }
    .task-mini-block p {
      margin: 5px 0;
      font-size: 12px;
      color: #555;
    }
    .task-mini-block .priority-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 5px;
    }
    .task-mini-block .priority-dot.low { background: green; }
    .task-mini-block .priority-dot.medium { background: orange; }
    .task-mini-block .priority-dot.high { background: red; }
    .task-mini-block .delete-btn {
      color: red;
      cursor: pointer;
      border: none;
      background: none;
      font-size: 12px;
    }
    .close-modal {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      color: #333;
    }
    @keyframes modalFadeIn {
      from { opacity: 0; transform: translate(-50%, -50%) scale(0); }
      to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    }
    @keyframes modalFadeOut {
      from { opacity: 1; transform: translate(-50%, -50%) scale(1); }
      to { opacity: 0; transform: translate(-50%, -50%) scale(0); }
    }
  </style>
</head>
<body>
  <div class="dashboard-wrapper">
    <aside class="sidebar">
      <div class="user-section">
        <img src="icon.svg" alt="User Avatar" class="user-avatar" />
        <button id="userButton" class="user-name">kindmikee ‚ñæ</button>
        <ul id="dropdownMenu" class="dropdown hidden">
          <li><a href="#">–ü—Ä–æ—Ñ–∏–ª—å</a></li>
          <li><a href="#">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</a></li>
          <li><button id="logoutBtn">–í—ã–π—Ç–∏</button></li>
        </ul>
      </div>

      <nav class="sidebar-menu">
        <button class="menu-button add-task">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
        <button class="menu-button">üìã –ó–∞–¥–∞—á–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</button>
        <button class="menu-button">üìÜ –ö–∞–ª–µ–Ω–¥–∞—Ä—å</button>
        <button class="menu-button">‚è±Ô∏è –ü–æ–º–æ–¥–æ—Ä–æ —Ç–∞–π–º–µ—Ä</button>

        <div class="projects-block">
          <h3 class="projects-title">–ú–æ–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</h3>
          <ul class="projects-list">
            <li class="project-item" data-category="–£—á—ë–±–∞">–£—á—ë–±–∞<span class="project-count" id="count-study">0</span></li>
            <li class="project-item" data-category="–†–∞–±–æ—Ç–∞">–†–∞–±–æ—Ç–∞<span class="project-count" id="count-work">0</span></li>
            <li class="project-item" data-category="–ó–¥–æ—Ä–æ–≤—å–µ">–ó–¥–æ—Ä–æ–≤—å–µ<span class="project-count" id="count-health">0</span></li>
            <li class="project-item" data-category="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ<span class="project-count" id="count-other">0</span></li>
          </ul>
        </div>
      </nav>
    </aside>

    <main class="main-content">
      <section id="welcome-screen" class="content-section active">
        <h1 class="main-heading">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Taskmate</h1>
        <p class="main-text">–í—ã–±–µ—Ä–∏—Ç–µ –ø—É–Ω–∫—Ç –º–µ–Ω—é —Å–ª–µ–≤–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É.</p>
        <p id="auth-error" class="error"></p>
      </section>

      <section id="tasks-section" class="content-section">
        <h2 class="main-heading">üìã –ó–∞–¥–∞—á–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</h2>
        <ul id="task-list"></ul>
      </section>

      <section id="calendar-section" class="content-section">
        <h2 class="main-heading">üìÜ –ö–∞–ª–µ–Ω–¥–∞—Ä—å</h2>
        <div class="calendar-nav">
          <button id="prev-month">–ü—Ä–µ–¥—ã–¥—É—â–∏–π</button>
          <h3 id="current-month"></h3>
          <button id="next-month">–°–ª–µ–¥—É—é—â–∏–π</button>
        </div>
        <div class="calendar-grid" id="calendar-grid">
        </div>
      </section>

      <section id="pomodoro-section" class="content-section">
        <h2 class="main-heading" style="text-align: center;">‚è±Ô∏è –ü–æ–º–æ–¥–æ—Ä–æ –¢–∞–π–º–µ—Ä</h2>
        <div class="pomodoro-container">
          <div class="pomodoro-timer">
            <span id="timer-label">–†–∞–±–æ—Ç–∞</span>
            <div id="time-display">25:00</div>
            <div class="pomodoro-controls">
              <button id="start-btn">–°—Ç–∞—Ä—Ç</button>
              <button id="pause-btn">–ü–∞—É–∑–∞</button>
              <button id="reset-btn">–°–±—Ä–æ—Å</button>
            </div>
          </div>

          <div class="pomodoro-settings">
            <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
            <label>–†–∞–±–æ—Ç–∞ (–º–∏–Ω): <input type="number" id="work-duration" value="25" min="1" /></label>
            <label>–ö–æ—Ä–æ—Ç–∫–∏–π –ø–µ—Ä–µ—Ä—ã–≤ (–º–∏–Ω): <input type="number" id="short-break" value="5" min="1" /></label>
            <label>–î–ª–∏–Ω–Ω—ã–π –ø–µ—Ä–µ—Ä—ã–≤ (–º–∏–Ω): <input type="number" id="long-break" value="15" min="1" /></label>
            <label>–¶–∏–∫–ª–æ–≤ –¥–æ –¥–ª–∏–Ω–Ω–æ–≥–æ –ø–µ—Ä–µ—Ä—ã–≤–∞: <input type="number" id="cycles" value="4" min="1" /></label>
          </div>
        </div>
      </section>
    </main>
  </div>

  <div id="task-panel" class="task-panel hidden" style="position: fixed; top: 20%; left: 50%; transform: translateX(-50%); background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); width: 320px; z-index: 1000;">
    <div class="task-header">
      <input type="text" class="task-title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏" />
      <textarea class="task-description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></textarea>
    </div>

    <div class="task-options">
      <div class="task-field">
        <label for="task-start">üìÖ –ù–∞—á–∞–ª–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
        <input type="date" id="task-start" class="task-input" />
      </div>
      <div class="task-field">
        <label for="task-end">üìÖ –ö–æ–Ω–µ—Ü (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
        <input type="date" id="task-end" class="task-input" />
      </div>
      <div class="task-field">
        <label for="task-due-date">üìÖ –°—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:</label>
        <input type="date" id="task-due-date" class="task-input" />
      </div>
      <div class="task-field">
        <label for="task-priority">üèÅ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:</label>
        <select id="task-priority" class="task-input">
          <option value="low">–ù–∏–∑–∫–∏–π</option>
          <option value="medium" selected>–°—Ä–µ–¥–Ω–∏–π</option>
          <option value="high">–í—ã—Å–æ–∫–∏–π</option>
        </select>
      </div>
    </div>

    <div class="task-footer" style="margin-top: 10px; display: flex; justify-content: space-between; align-items: center;">
      <select class="task-category">
        <option value="–£—á—ë–±–∞">–£—á—ë–±–∞</option>
        <option value="–†–∞–±–æ—Ç–∞">–†–∞–±–æ—Ç–∞</option>
        <option value="–ó–¥–æ—Ä–æ–≤—å–µ">–ó–¥–æ—Ä–æ–≤—å–µ</option>
        <option value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
      </select>
      <div class="task-actions">
        <button class="cancel-button">–û—Ç–º–µ–Ω–∞</button>
        <button class="add-button">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
      </div>
    </div>
  </div>

  <div id="task-modal" class="task-modal">
    <button class="close-modal">√ó</button>
    <div id="modal-content" class="task-modal-content"></div>
  </div>

<script>
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  async function checkAuth() {
    try {
      const response = await fetch('http://localhost:3000/api/auth/me', {
        credentials: 'include',
      });
      if (!response.ok) throw new Error('–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã');
      const data = await response.json();
      localStorage.setItem('userId', data.userId);
      document.getElementById('welcome-screen').classList.remove('active');
      document.getElementById('tasks-section').classList.add('active');
      loadTasks();
      updateCategoryCounts();
    } catch (err) {
      document.getElementById('auth-error').textContent = '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É. ' + err.message;
      document.getElementById('welcome-screen').classList.add('active');
      document.getElementById('tasks-section').classList.remove('active');
    }
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á
  async function loadTasks() {
    try {
      const userId = localStorage.getItem('userId');
      if (!userId) throw new Error('userId –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ localStorage');
      const response = await fetch(`http://localhost:3000/api/tasks?userId=${userId}`, {
        credentials: 'include',
      });
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á: ${response.status} - ${errorText}`);
      }
      const tasks = await response.json();
      console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏:', tasks);
      const taskList = document.getElementById('task-list');
      taskList.innerHTML = '';
      const today = new Date('2025-05-20T15:40:00+03:00'); // –¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è: 03:40 PM EEST, 20 –º–∞—è 2025
      const todayStr = today.toLocaleDateString('en-CA');
      console.log('–°–µ–≥–æ–¥–Ω—è—à–Ω—è—è –¥–∞—Ç–∞:', todayStr);

      const uniqueTasks = {};
      tasks.forEach(task => {
        if (!task.title) return;
        const taskDueDateStr = task.dueDate ? new Date(task.dueDate).toLocaleDateString('en-CA') : null;
        const taskStartStr = task.start ? new Date(task.start).toLocaleDateString('en-CA') : null;
        const taskEndStr = task.end ? new Date(task.end).toLocaleDateString('en-CA') : null;

        if ((taskDueDateStr && taskDueDateStr === todayStr) ||
            (taskStartStr && taskEndStr && todayStr >= taskStartStr && todayStr <= taskEndStr)) {
          const key = `${task.title}-${task.category || '–î—Ä—É–≥–æ–µ'}`;
          if (!uniqueTasks[key]) {
            uniqueTasks[key] = task;
          }
        }
      });

      Object.values(uniqueTasks).forEach(task => {
        const taskItem = document.createElement('li');
        taskItem.classList.add('task-item', task.priority);
        let durationDays = task.durationDays || 1;
        if (task.start && task.end) {
          const startDate = new Date(task.start);
          const endDate = new Date(task.end);
          durationDays = Math.round((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
        }
        const priorityLabels = {
          low: '–ù–∏–∑–∫–∏–π',
          medium: '–°—Ä–µ–¥–Ω–∏–π',
          high: '–í—ã—Å–æ–∫–∏–π'
        };
        taskItem.innerHTML = `
          <div class="task-header">
            <h3 class="task-title">${task.title}</h3>
            <span class="task-priority ${task.priority}">‚óè</span>
          </div>
          ${task.description ? `<p class="task-description">${task.description}</p>` : '<p class="task-description">–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</p>'}
          <div class="task-meta">
            <span class="task-due-date">–°—Ä–æ–∫: ${task.dueDate ? new Date(task.dueDate).toLocaleDateString('ru-RU') : '–Ω–µ —É–∫–∞–∑–∞–Ω'} (–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${durationDays} –¥–Ω.)</span>
            <span class="task-category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${task.category || '–î—Ä—É–≥–æ–µ'}</span>
          </div>
          <p><span class="priority-dot ${task.priority}"></span> –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: ${priorityLabels[task.priority]}</p>
          <button class="delete-btn" data-id="${task._id}">–£–¥–∞–ª–∏—Ç—å</button>
        `;
        taskList.appendChild(taskItem);
      });

      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const taskId = btn.dataset.id;
          await deleteTask(taskId);
        });
      });
      updateCategoryCounts(tasks);
    } catch (err) {
      document.getElementById('auth-error').textContent = err.message;
      console.error('–û—à–∏–±–∫–∞ –≤ loadTasks:', err);
    }
  }

  // –ö–∞–ª–µ–Ω–¥–∞—Ä—å
  let currentDate = new Date('2025-05-20T15:40:00+03:00');
  let currentMonth = currentDate.getMonth();
  let currentYear = currentDate.getFullYear();
  let tasksCache = [];
  let isRendering = false;

  async function fetchTasksForCalendar() {
    try {
      const userId = localStorage.getItem('userId');
      if (!userId) throw new Error('userId –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ localStorage');
      const response = await fetch(`http://localhost:3000/api/tasks?userId=${userId}`, {
        credentials: 'include',
      });
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á: ${response.status} - ${errorText}`);
      }
      tasksCache = await response.json();
      console.log('Tasks for calendar:', tasksCache);
      return tasksCache;
    } catch (err) {
      document.getElementById('auth-error').textContent = err.message;
      console.error('–û—à–∏–±–∫–∞ –≤ fetchTasksForCalendar:', err);
      return [];
    }
  }

  async function fetchTasksForDay(dateStr) {
    try {
      const userId = localStorage.getItem('userId');
      const response = await fetch(`http://localhost:3000/api/tasks?userId=${userId}`, {
        credentials: 'include',
      });
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á: ${response.status} - ${errorText}`);
      }
      const tasks = await response.json();
      return tasks.filter(task => {
        const taskDueDateStr = task.dueDate ? new Date(task.dueDate).toLocaleDateString('en-CA') : null;
        const taskStartStr = task.start ? new Date(task.start).toLocaleDateString('en-CA') : null;
        const taskEndStr = task.end ? new Date(task.end).toLocaleDateString('en-CA') : null;
        return (taskDueDateStr && taskDueDateStr === dateStr) ||
               (taskStartStr && taskEndStr && dateStr >= taskStartStr && dateStr <= taskEndStr);
      });
    } catch (err) {
      document.getElementById('auth-error').textContent = err.message;
      console.error('–û—à–∏–±–∫–∞ –≤ fetchTasksForDay:', err);
      return [];
    }
  }

  async function renderCalendar() {
    if (isRendering) return;
    isRendering = true;

    const calendarGrid = document.getElementById('calendar-grid');
    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
    const firstDay = new Date(currentYear, currentMonth, 1).getDay();
    const adjustedFirstDay = firstDay === 0 ? 6 : firstDay - 1;

    calendarGrid.innerHTML = '';

    const daysOfWeek = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
    daysOfWeek.forEach(day => {
      const dayHeader = document.createElement('div');
      dayHeader.classList.add('calendar-day-header');
      dayHeader.textContent = day;
      calendarGrid.appendChild(dayHeader);
    });

    document.getElementById('current-month').textContent = `${currentDate.toLocaleString('ru-RU', { month: 'long' })} ${currentYear}`;

    for (let i = 0; i < adjustedFirstDay; i++) {
      const emptyDay = document.createElement('div');
      emptyDay.classList.add('calendar-day');
      calendarGrid.appendChild(emptyDay);
    }

    try {
      const tasks = await fetchTasksForCalendar();
      for (let day = 1; day <= daysInMonth; day++) {
        const dayDiv = document.createElement('div');
        dayDiv.classList.add('calendar-day');
        dayDiv.innerHTML = `<span>${day}</span>`;
        const currentDay = new Date(currentYear, currentMonth, day);
        const currentDayStr = currentDay.toLocaleDateString('en-CA');

        const taskCount = tasks.reduce((count, task) => {
          const taskDueDateStr = task.dueDate ? new Date(task.dueDate).toLocaleDateString('en-CA') : null;
          const taskStartStr = task.start ? new Date(task.start).toLocaleDateString('en-CA') : null;
          const taskEndStr = task.end ? new Date(task.end).toLocaleDateString('en-CA') : null;
          if ((taskDueDateStr && taskDueDateStr === currentDayStr) ||
              (taskStartStr && taskEndStr && currentDayStr >= taskStartStr && currentDayStr <= taskEndStr)) {
            count++;
          }
          return count;
        }, 0);

        if (taskCount > 0) {
          const taskCountEl = document.createElement('div');
          taskCountEl.classList.add('calendar-task-count');
          taskCountEl.textContent = taskCount;
          dayDiv.appendChild(taskCountEl);
        }

        dayDiv.addEventListener('click', async (e) => {
          if (!e.target.classList.contains('calendar-task-count')) {
            const selectedDate = new Date(currentYear, currentMonth, day).toLocaleDateString('en-CA');
            const tasks = await fetchTasksForDay(selectedDate);
            showModal(selectedDate, tasks);
          }
        });

        calendarGrid.appendChild(dayDiv);
      }
    } catch (err) {
      console.error('–û—à–∏–±–∫–∞ –≤ renderCalendar:', err);
    } finally {
      isRendering = false;
    }
  }

  function showModal(dateStr, tasks) {
    const modal = document.getElementById('task-modal');
    const modalContent = document.getElementById('modal-content');
    const priorityLabels = {
      low: '–ù–∏–∑–∫–∏–π',
      medium: '–°—Ä–µ–¥–Ω–∏–π',
      high: '–í—ã—Å–æ–∫–∏–π'
    };
    modalContent.innerHTML = `
      <h3>–ó–∞–¥–∞—á–∏ –Ω–∞ ${new Date(dateStr).toLocaleDateString('ru-RU')}</h3>
      <ul>
        ${
          tasks.length > 0
            ? tasks.map(task => {
                let durationDays = task.durationDays || 1;
                if (task.start && task.end) {
                  const startDate = new Date(task.start);
                  const endDate = new Date(task.end);
                  durationDays = Math.round((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                }
                return `
                  <li class="task-mini-block">
                    <h4>${task.title}</h4>
                    ${task.description ? `<p>–û–ø–∏—Å–∞–Ω–∏–µ: ${task.description}</p>` : ''}
                    <p>–°—Ä–æ–∫: ${task.dueDate ? new Date(task.dueDate).toLocaleDateString('ru-RU') : '–Ω–µ —É–∫–∞–∑–∞–Ω'} (–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${durationDays} –¥–Ω.)</p>
                    <p><span class="priority-dot ${task.priority}"></span> –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: ${priorityLabels[task.priority]}</p>
                    <p>–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${task.category || '–î—Ä—É–≥–æ–µ'}</p>
                    <button class="delete-btn" data-id="${task._id}">–£–¥–∞–ª–∏—Ç—å</button>
                  </li>
                `;
              }).join('')
            : '<li>–ù–µ—Ç –∑–∞–¥–∞—á</li>'
        }
      </ul>
    `;
    modal.style.display = 'block';
    modal.classList.add('active');

    // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
    modal.removeEventListener('click', handleModalClick);
    modal.addEventListener('click', handleModalClick);

    function handleModalClick(e) {
      const target = e.target;
      if (target.classList.contains('delete-btn')) {
        const taskId = target.dataset.id;
        deleteTask(taskId).then(() => {
          hideModal();
          renderCalendar();
        });
      }
    }
  }

  function hideModal() {
    const modal = document.getElementById('task-modal');
    modal.classList.remove('active');
    modal.addEventListener('animationend', () => {
      modal.style.display = 'none';
    }, { once: true });
  }

  document.querySelector('.close-modal').addEventListener('click', () => {
    hideModal();
  });

  document.getElementById('prev-month').addEventListener('click', () => {
    currentMonth--;
    if (currentMonth < 0) {
      currentMonth = 11;
      currentYear--;
    }
    currentDate = new Date(currentYear, currentMonth, 1);
    renderCalendar();
  });

  document.getElementById('next-month').addEventListener('click', () => {
    currentMonth++;
    if (currentMonth > 11) {
      currentMonth = 0;
      currentYear++;
    }
    currentDate = new Date(currentYear, currentMonth, 1);
    renderCalendar();
  });

  function openTaskPanel(date) {
    resetTaskPanel();
    taskPanel.querySelector('#task-start').value = date;
    taskPanel.querySelector('#task-end').value = date;
    taskPanel.querySelector('#task-due-date').value = date;
    taskPanel.classList.remove('hidden');
  }

  const addButton = document.querySelector('.add-button');
  addButton.addEventListener('click', async () => {
    const title = taskPanel.querySelector('.task-title').value.trim();
    if (!title) {
      alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏!');
      return;
    }
    const description = taskPanel.querySelector('.task-description').value.trim();
    const start = taskPanel.querySelector('#task-start').value;
    const end = taskPanel.querySelector('#task-end').value;
    let dueDate = taskPanel.querySelector('#task-due-date').value;
    const priority = taskPanel.querySelector('#task-priority').value;
    const category = taskPanel.querySelector('.task-category').value;
    const userId = localStorage.getItem('userId');

    if (end && !dueDate) {
      dueDate = end;
      taskPanel.querySelector('#task-due-date').value = end;
    }

    if (!dueDate) {
      alert('–£–∫–∞–∂–∏—Ç–µ —Å—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏!');
      return;
    }

    if (!userId) {
      alert('–û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
      return;
    }

    try {
      const baseTask = { title, description, priority, category, userId };
      console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º–∞—è –∑–∞–¥–∞—á–∞:', baseTask);

      let durationDays = 1;
      if (start && end) {
        const startDate = new Date(start);
        const endDate = new Date(end);
        if (startDate > endDate) {
          alert('–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–∑–∂–µ –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è!');
          return;
        }
        durationDays = Math.round((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
        baseTask.start = start;
        baseTask.end = end;
      }
      baseTask.dueDate = dueDate;
      baseTask.durationDays = durationDays;

      const response = await fetch('http://localhost:3000/api/tasks', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify(baseTask),
      });
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏: ${response.status} - ${errorText}`);
      }

      await fetchTasksForCalendar();

      taskPanel.classList.add('hidden');
      resetTaskPanel();
      showSection('calendar-section');
      renderCalendar();
      loadTasks();
      updateCategoryCounts();

      const modal = document.getElementById('task-modal');
      if (modal.classList.contains('active')) {
        const selectedDate = dueDate || start;
        if (selectedDate) {
          const tasks = await fetchTasksForDay(selectedDate);
          showModal(selectedDate, tasks);
        }
      }
    } catch (err) {
      document.getElementById('auth-error').textContent = err.message;
      console.error('–û—à–∏–±–∫–∞ –≤ addButton:', err);
    }
  });

  async function deleteTask(taskId) {
    try {
      const response = await fetch(`http://localhost:3000/api/tasks/${taskId}`, {
        method: 'DELETE',
        credentials: 'include',
      });
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏: ${response.status} - ${errorText}`);
      }
      await fetchTasksForCalendar();
      loadTasks();
      renderCalendar();
      updateCategoryCounts();
    } catch (err) {
      document.getElementById('auth-error').textContent = err.message;
      console.error('–û—à–∏–±–∫–∞ –≤ deleteTask:', err);
    }
  }

  document.getElementById('logoutBtn').addEventListener('click', async () => {
    try {
      await fetch('http://localhost:3000/api/auth/logout', {
        method: 'POST',
        credentials: 'include',
      });
      localStorage.removeItem('userId');
      window.location.href = '/index.html';
    } catch (err) {
      document.getElementById('auth-error').textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ: ' + err.message;
      console.error('–û—à–∏–±–∫–∞ –≤ logoutBtn:', err);
    }
  });

  const userButton = document.getElementById("userButton");
  const dropdownMenu = document.getElementById("dropdownMenu");
  userButton.addEventListener("click", (e) => {
    e.stopPropagation();
    dropdownMenu.classList.toggle("hidden");
  });

  document.addEventListener("click", () => {
    if (!dropdownMenu.classList.contains("hidden")) {
      dropdownMenu.classList.add("hidden");
    }
  });

  const addTaskBtn = document.querySelector('.add-task');
  const taskPanel = document.getElementById('task-panel');
  const cancelBtn = document.querySelector('.cancel-button');

  addTaskBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    resetTaskPanel();
    taskPanel.classList.remove('hidden');
  });

  cancelBtn.addEventListener('click', () => {
    taskPanel.classList.add('hidden');
  });

  document.addEventListener('click', (e) => {
    if (!taskPanel.contains(e.target) && !addTaskBtn.contains(e.target)) {
      taskPanel.classList.add('hidden');
    }
  });

  const sections = document.querySelectorAll('.content-section');
  const menuButtons = document.querySelectorAll('.menu-button');
  const sectionIds = ['tasks-section', 'calendar-section', 'pomodoro-section'];
  menuButtons.forEach((btn, index) => {
    if (index >= 1 && index <= 3) {
      btn.addEventListener('click', () => {
        showSection(sectionIds[index - 1]);
        if (sectionIds[index - 1] === 'calendar-section') {
          renderCalendar();
        } else if (sectionIds[index - 1] === 'tasks-section') {
          loadTasks();
        }
      });
    }
  });

  function showSection(id) {
    sections.forEach(sec => sec.classList.remove('active'));
    const activeSection = document.getElementById(id);
    if (activeSection) activeSection.classList.add('active');
  }

  let timer;
  let isRunning = false;
  let mode = 'work';
  let timeLeft = 1500;
  let cycleCount = 0;

  function updateDisplay() {
    const minutes = String(Math.floor(timeLeft / 60)).padStart(2, '0');
    const seconds = String(timeLeft % 60).padStart(2, '0');
    document.getElementById('time-display').textContent = `${minutes}:${seconds}`;
    document.getElementById('timer-label').textContent =
      mode === 'work' ? '–†–∞–±–æ—Ç–∞' : mode === 'short' ? '–ö–æ—Ä–æ—Ç–∫–∏–π –ø–µ—Ä–µ—Ä—ã–≤' : '–î–ª–∏–Ω–Ω—ã–π –ø–µ—Ä–µ—Ä—ã–≤';
  }

  function startTimer() {
    if (isRunning) return;
    isRunning = true;
    timer = setInterval(() => {
      if (timeLeft > 0) {
        timeLeft--;
        updateDisplay();
      } else {
        clearInterval(timer);
        isRunning = false;
        switchMode();
      }
    }, 1000);
  }

  function pauseTimer() {
    clearInterval(timer);
    isRunning = false;
  }

  function resetTimer() {
    clearInterval(timer);
    isRunning = false;
    setInitialTime();
    updateDisplay();
  }

  function switchMode() {
    const work = +document.getElementById('work-duration').value * 60;
    const short = +document.getElementById('short-break').value * 60;
    const long = +document.getElementById('long-break').value * 60;
    const cycles = +document.getElementById('cycles').value;

    if (mode === 'work') {
      cycleCount++;
      if (cycleCount % cycles === 0) {
        mode = 'long';
        timeLeft = long;
      } else {
        mode = 'short';
        timeLeft = short;
      }
    } else {
      mode = 'work';
      timeLeft = work;
    }
    updateDisplay();
    startTimer();
  }

  function setInitialTime() {
    const work = +document.getElementById('work-duration').value * 60;
    timeLeft = work;
    mode = 'work';
  }

  document.getElementById('start-btn').addEventListener('click', startTimer);
  document.getElementById('pause-btn').addEventListener('click', pauseTimer);
  document.getElementById('reset-btn').addEventListener('click', () => {
    resetTimer();
    cycleCount = 0;
  });

  setInitialTime();
  updateDisplay();

  function resetTaskPanel() {
    taskPanel.querySelector('.task-title').value = '';
    taskPanel.querySelector('.task-description').value = '';
    taskPanel.querySelector('#task-start').value = '';
    taskPanel.querySelector('#task-end').value = '';
    taskPanel.querySelector('#task-due-date').value = '';
    taskPanel.querySelector('#task-priority').value = 'medium';
    taskPanel.querySelector('.task-category').value = '–î—Ä—É–≥–æ–µ';
  }

  async function fetchAllTasks() {
    try {
      const userId = localStorage.getItem('userId');
      if (!userId) throw new Error('userId –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ localStorage');
      const response = await fetch(`http://localhost:3000/api/tasks?userId=${userId}`, {
        credentials: 'include',
      });
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á: ${response.status} - ${errorText}`);
      }
      const tasks = await response.json();
      const uniqueTasks = {};
      tasks.forEach(task => {
        const key = `${task.title}-${task.category || '–î—Ä—É–≥–æ–µ'}`;
        if (!uniqueTasks[key]) {
          uniqueTasks[key] = task;
        }
      });
      return Object.values(uniqueTasks);
    } catch (err) {
      document.getElementById('auth-error').textContent = err.message;
      console.error('–û—à–∏–±–∫–∞ –≤ fetchAllTasks:', err);
      return [];
    }
  }

  async function displayTasksByCategory(category) {
    const tasks = await fetchAllTasks();
    const filteredTasks = tasks.filter(task => task.category === category);
    const modal = document.getElementById('task-modal');
    const modalContent = document.getElementById('modal-content');
    const priorityLabels = {
      low: '–ù–∏–∑–∫–∏–π',
      medium: '–°—Ä–µ–¥–Ω–∏–π',
      high: '–í—ã—Å–æ–∫–∏–π'
    };
    modalContent.innerHTML = `
      <h3>–ó–∞–¥–∞—á–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: ${category}</h3>
      <ul>
        ${
          filteredTasks.length > 0
            ? filteredTasks.map(task => {
                let durationDays = 1;
                if (task.start && task.end) {
                  const startDate = new Date(task.start);
                  const endDate = new Date(task.end);
                  durationDays = Math.round((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                }
                return `
                  <li class="task-mini-block">
                    <h4>${task.title}</h4>
                    ${task.description ? `<p>–û–ø–∏—Å–∞–Ω–∏–µ: ${task.description}</p>` : ''}
                    <p>–°—Ä–æ–∫: ${task.dueDate ? new Date(task.dueDate).toLocaleDateString('ru-RU') : '–Ω–µ —É–∫–∞–∑–∞–Ω'} (–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${durationDays} –¥–Ω.)</p>
                    <p><span class="priority-dot ${task.priority}"></span> –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: ${priorityLabels[task.priority]}</p>
                    <button class="delete-btn" data-id="${task._id}">–£–¥–∞–ª–∏—Ç—å</button>
                  </li>
                `;
              }).join('')
            : '<li>–ù–µ—Ç –∑–∞–¥–∞—á</li>'
        }
      </ul>
    `;
    modal.style.display = 'block';
    modal.classList.add('active');

    // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
    modal.removeEventListener('click', handleCategoryModalClick);
    modal.addEventListener('click', handleCategoryModalClick);

    function handleCategoryModalClick(e) {
      const target = e.target;
      if (target.classList.contains('delete-btn')) {
        const taskId = target.dataset.id;
        deleteTask(taskId).then(() => {
          // –û–±–Ω–æ–≤–ª—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è
          displayTasksByCategory(category);
        });
      }
    }
  }

  function updateCategoryCounts(tasks = null) {
    if (!tasks) {
      fetchAllTasks().then(tasks => {
        const counts = {
          '–£—á—ë–±–∞': 0,
          '–†–∞–±–æ—Ç–∞': 0,
          '–ó–¥–æ—Ä–æ–≤—å–µ': 0,
          '–î—Ä—É–≥–æ–µ': 0
        };
        tasks.forEach(task => {
          counts[task.category || '–î—Ä—É–≥–æ–µ']++;
        });
        document.getElementById('count-study').textContent = counts['–£—á—ë–±–∞'];
        document.getElementById('count-work').textContent = counts['–†–∞–±–æ—Ç–∞'];
        document.getElementById('count-health').textContent = counts['–ó–¥–æ—Ä–æ–≤—å–µ'];
        document.getElementById('count-other').textContent = counts['–î—Ä—É–≥–æ–µ'];
      });
    } else {
      const counts = {
        '–£—á—ë–±–∞': 0,
        '–†–∞–±–æ—Ç–∞': 0,
        '–ó–¥–æ—Ä–æ–≤—å–µ': 0,
        '–î—Ä—É–≥–æ–µ': 0
      };
      const uniqueTasks = {};
      tasks.forEach(task => {
        const key = `${task.title}-${task.category || '–î—Ä—É–≥–æ–µ'}`;
        if (!uniqueTasks[key]) {
          uniqueTasks[key] = task;
          counts[task.category || '–î—Ä—É–≥–æ–µ']++;
        }
      });
      document.getElementById('count-study').textContent = counts['–£—á—ë–±–∞'];
      document.getElementById('count-work').textContent = counts['–†–∞–±–æ—Ç–∞'];
      document.getElementById('count-health').textContent = counts['–ó–¥–æ—Ä–æ–≤—å–µ'];
      document.getElementById('count-other').textContent = counts['–î—Ä—É–≥–æ–µ'];
    }
  }

  document.querySelectorAll('.project-item').forEach(item => {
    item.addEventListener('click', () => {
      const category = item.getAttribute('data-category');
      displayTasksByCategory(category);
    });
  });

  checkAuth();
</script>
</body>
</html>